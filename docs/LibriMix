# LibriMix Dataset å¤„ç†ä¸ DataLoader è¯´æ˜

## **1. ä»£ç æ¦‚è¿°**
æœ¬ä»£ç å®šä¹‰äº†ä¸€ä¸ª **LibriMixDataset** ç±»ç”¨äºåŠ è½½ LibriMix æ•°æ®é›†ï¼Œå¹¶åˆ›å»ºäº†ä¸€ä¸ª **DataLoader** è¿›è¡Œæ‰¹é‡æ•°æ®å¤„ç†ã€‚

## **2. ä¸»è¦åŠŸèƒ½**
- **å¯¹é½æ•°æ®æ–‡ä»¶**ï¼šç¡®ä¿ `mix_clean/`ã€`s1/` å’Œ `s2/` ç›®å½•ä¸‹çš„æ–‡ä»¶ä¸€è‡´ã€‚
- **è¯»å–éŸ³é¢‘æ–‡ä»¶**ï¼šä½¿ç”¨ `torchaudio` åŠ è½½æ··åˆè¯­éŸ³ (`mix_clean`) å’Œç›®æ ‡è¯­éŸ³ (`s1`, `s2`)ã€‚
- **æ•°æ®é¢„å¤„ç†**ï¼š
  - ç¡®ä¿æ‰€æœ‰éŸ³é¢‘æ˜¯å•é€šé“ï¼ˆå¦‚æœæœ‰å¤šé€šé“åˆ™å–å¹³å‡ï¼‰ã€‚
  - å¤„ç†å˜é•¿éŸ³é¢‘ï¼Œä½¿ç”¨ **Padding** å¡«å……ï¼Œä½¿æ‰¹é‡æ•°æ®é•¿åº¦ä¸€è‡´ã€‚
- **è¿”å›æ•°æ®**ï¼š`mix_wav`ã€`s1_wav`ã€`s2_wav` ä»¥åŠ `sr`ï¼ˆé‡‡æ ·ç‡ï¼‰ã€‚

## **3. ä»£ç è§£æ**

### **3.1 LibriMixDataset ç±»**
è¯¥ç±»è´Ÿè´£åŠ è½½æ•°æ®é›†ï¼Œå¹¶å¯¹é½ `mix_clean/`ã€`s1/` å’Œ `s2/` ä¸­çš„æ–‡ä»¶ã€‚
```python
class LibriMixDataset(Dataset):
    def __init__(self, data_root):
        self.data_root = data_root
        mix_files = set(os.listdir(os.path.join(data_root, "mix_clean")))
        s1_files = set(os.listdir(os.path.join(data_root, "s1")))
        s2_files = set(os.listdir(os.path.join(data_root, "s2")))

        # å–äº¤é›†,ç¡®ä¿æ–‡ä»¶ä¸€è‡´
        common_files = sorted(list(mix_files & s1_files & s2_files))
        self.mix_files = common_files
        self.s1_files = common_files
        self.s2_files = common_files

        print(f"å¯¹é½åæ–‡ä»¶æ•°: {len(self.mix_files)}")
```
**ğŸ“Œ è¯´æ˜ï¼š**
- `mix_files`, `s1_files`, `s2_files`ï¼šåˆ†åˆ«å­˜å‚¨ `mix_clean/`ã€`s1/` å’Œ `s2/` ç›®å½•ä¸­çš„æ–‡ä»¶åˆ—è¡¨ã€‚
- `common_files`ï¼šè®¡ç®—äº¤é›†ï¼Œç¡®ä¿æ•°æ®å¯¹é½ã€‚
- `self.mix_files`, `self.s1_files`, `self.s2_files`ï¼šæœ€ç»ˆå­˜å‚¨çš„æ•°æ®é›†æ–‡ä»¶åˆ—è¡¨ã€‚

### **3.2 è¯»å–éŸ³é¢‘æ–‡ä»¶**
```python
    def __getitem__(self, idx):
        mix_path = os.path.join(self.data_root, "mix_clean", self.mix_files[idx])
        s1_path = os.path.join(self.data_root, "s1", self.s1_files[idx])
        s2_path = os.path.join(self.data_root, "s2", self.s2_files[idx])
    
        # è¯»å–éŸ³é¢‘
        mix_wav, sr = torchaudio.load(mix_path)
        s1_wav, _ = torchaudio.load(s1_path)
        s2_wav, _ = torchaudio.load(s2_path)

        # ç¡®ä¿å•é€šé“
        mix_wav = mix_wav.mean(dim=0, keepdim=True) if mix_wav.shape[0] > 1 else mix_wav
        s1_wav = s1_wav.mean(dim=0, keepdim=True) if s1_wav.shape[0] > 1 else s1_wav
        s2_wav = s2_wav.mean(dim=0, keepdim=True) if s2_wav.shape[0] > 1 else s2_wav

        return mix_wav, s1_wav, s2_wav, sr
```
**ğŸ“Œ è¯´æ˜ï¼š**
- `torchaudio.load()` è¯»å–éŸ³é¢‘æ•°æ®ã€‚
- **ç¡®ä¿å•é€šé“**ï¼šå¦‚æœéŸ³é¢‘æ˜¯ **å¤šé€šé“**ï¼Œåˆ™è®¡ç®—å¹³å‡å€¼è½¬æ¢ä¸ºå•é€šé“ã€‚

---

### **3.3 å¤„ç†å˜é•¿æ•°æ® (collate_fn)**
éŸ³é¢‘æ•°æ®é•¿åº¦å¯èƒ½ä¸åŒï¼Œå› æ­¤ä½¿ç”¨ **å¡«å…… (Padding)** ä½¿å…¶å¯¹é½ã€‚
```python
def collate_fn(batch):
    mix, s1, s2, sr = zip(*batch)

    # ç¡®ä¿æ‰€æœ‰éŸ³é¢‘æ ¼å¼ä¸º (1, length)
    mix = [x if x.dim() == 2 else x.unsqueeze(0) for x in mix]
    s1 = [x if x.dim() == 2 else x.unsqueeze(0) for x in s1]
    s2 = [x if x.dim() == 2 else x.unsqueeze(0) for x in s2]

    # è®¡ç®—æœ€é•¿çš„éŸ³é¢‘é•¿åº¦
    max_len = max(x.shape[1] for x in mix)

    # å¡«å……å‡½æ•°
    def pad_audio(wav, target_len):
        pad_size = target_len - wav.shape[1]
        return torch.nn.functional.pad(wav, (0, pad_size))

    mix = torch.stack([pad_audio(x, max_len) for x in mix])
    s1 = torch.stack([pad_audio(x, max_len) for x in s1])
    s2 = torch.stack([pad_audio(x, max_len) for x in s2])

    return mix, s1, s2, sr
```
**ğŸ“Œ è¯´æ˜ï¼š**
- **è®¡ç®—æœ€é•¿éŸ³é¢‘é•¿åº¦**ï¼š`max_len = max(x.shape[1] for x in mix)`
- **å¡«å…… (Padding)**ï¼š`torch.nn.functional.pad()`
- **ç¡®ä¿æ‰¹é‡æ•°æ®æ ¼å¼ä¸€è‡´**

---

### **3.4 åˆ›å»º DataLoader**
```python
# è®¾ç½®æ•°æ®é›†è·¯å¾„
data_root = "train-360"
dataset = LibriMixDataset(data_root)

# åˆ›å»º DataLoader
dataloader = DataLoader(dataset, batch_size=4, shuffle=True, collate_fn=collate_fn)
```
**ğŸ“Œ è¯´æ˜ï¼š**
- `batch_size=4`ï¼šä¸€æ¬¡åŠ è½½ 4 æ¡æ•°æ®ã€‚
- `shuffle=True`ï¼šéšæœºæ‰“ä¹±æ•°æ®ã€‚
- `collate_fn=collate_fn`ï¼šä½¿ç”¨ **å¡«å……å‡½æ•°** å¤„ç†å˜é•¿æ•°æ®ã€‚

---

## **4. ä»£ç è¿è¡Œç¤ºä¾‹**
```python
for mix, s1, s2, sr in dataloader:
    print(f"é‡‡æ ·ç‡: {sr}")
    print(f"æ··åˆéŸ³é¢‘å½¢çŠ¶: {mix.shape}")  # (batch_size, 1, max_samples)
    break
```
è¿è¡Œåï¼Œä½ åº”è¯¥çœ‹åˆ°ï¼š
```
é‡‡æ ·ç‡: 8000
æ··åˆéŸ³é¢‘å½¢çŠ¶: torch.Size([4, 1, 32000])
```

---

## **5. å…³é”®ä¼˜åŒ–ç‚¹**
âœ… **å¯¹é½æ•°æ®æ–‡ä»¶**ï¼Œç¡®ä¿ `mix_clean/`ã€`s1/`ã€`s2/` ä¸€è‡´
âœ… **è‡ªåŠ¨å¤„ç†å¤šé€šé“éŸ³é¢‘**ï¼Œè½¬æ¢ä¸ºå•é€šé“
âœ… **ä½¿ç”¨ `collate_fn` å¤„ç†å˜é•¿æ•°æ®**ï¼Œç¡®ä¿ DataLoader ç”Ÿæˆå¯¹é½æ•°æ®
âœ… **æ”¯æŒæ‰¹é‡åŠ è½½**ï¼Œæé«˜è®­ç»ƒæ•ˆç‡

---

